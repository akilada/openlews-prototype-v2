name: PR Quality & Format

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
    branches: [main]

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: pr-quality-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    steps:
      - uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
            build
            infra
          requireScope: false

  branch-naming:
    name: Branch naming
    runs-on: ubuntu-latest
    steps:
      - name: Validate branch name
        shell: bash
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Branch: $BRANCH"

          # Allow common bot branches
          if [[ "$BRANCH" =~ ^dependabot/ ]] || [[ "$BRANCH" =~ ^renovate/ ]]; then
            echo "Bot branch allowed."
            exit 0
          fi

          # OpenLEWS convention
          if [[ "$BRANCH" =~ ^(feature|fix|hotfix|docs|chore|refactor|test|infra)/.+$ ]]; then
            echo "Branch name OK."
            exit 0
          fi

          echo "::error::Branch must match: (feature|fix|hotfix|docs|chore|refactor|test|infra)/<something>"
          exit 1

  python-quality:
    name: Python quality
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}/src
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            src/**/requirements.txt

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip

          # Install all sub-project requirements (detector/rag/ingestor + NSDI pipeline)
          while IFS= read -r -d '' req; do
            echo "Installing: $req"
            pip install -r "$req"
          done < <(find src -type f -name "requirements.txt" -print0)

          # CI tools (ensure present)
          pip install ruff black pytest

      - name: Ruff (lint)
        run: ruff check src scripts

      - name: Black (format check)
        run: black --check src scripts

    #   - name: Pytest
    #     run: pytest -q

  terraform-quality:
    name: Terraform quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt (check)
        run: terraform fmt -check -recursive modules

      - name: Terraform validate (each module)
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t MOD_DIRS < <(find modules -type f -name "*.tf" -print0 | xargs -0 -n1 dirname | sort -u)
          for d in "${MOD_DIRS[@]}"; do
            echo "=== Validating module: $d ==="
            (cd "$d" && terraform init -backend=false -input=false && terraform validate)
          done

  terragrunt-hclfmt:
    name: Terragrunt HCL format
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Terragrunt (pinned)
        shell: bash
        run: |
          set -euo pipefail
          TG_VERSION="v0.62.3"
          curl -sSL -o terragrunt "https://github.com/gruntwork-io/terragrunt/releases/download/${TG_VERSION}/terragrunt_linux_amd64"
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt
          terragrunt --version

      - name: terragrunt hclfmt (check)
        run: |
          # Formats/validates terragrunt.hcl + env.hcl files
          terragrunt hclfmt --terragrunt-check --terragrunt-diff

  yaml-json-lint:
    name: YAML+JSON lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (for yamllint)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install yamllint
        run: |
          python -m pip install --upgrade pip
          pip install yamllint

      - name: YAML lint
        run: |
          yamllint -d "{extends: default, rules: {line-length: disable}}" .

      - name: JSON parse check
        shell: bash
        run: |
          set -euo pipefail
          while IFS= read -r -d '' f; do
            python -m json.tool "$f" >/dev/null
          done < <(find . -type f -name "*.json" -print0)
